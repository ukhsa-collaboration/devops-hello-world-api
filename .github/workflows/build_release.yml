name: "Build, Test and Release"

on:
  pull_request:
  push:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  actions: read
  pull-requests: write

jobs:
  prepare-release-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.export.outputs.release_tag }}
    steps:
      - name: Checkout repository
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8

      - name: Bump tag
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: bump
        uses: ukhsa-collaboration/devops-github-actions/.github/actions/github-bump-tag@52f31c5544ee5204dd0e169728c595b6a402205f
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true

      - name: Export release tag
        id: export
        run: echo "release_tag=${{ steps.bump.outputs.new_tag }}" >> "$GITHUB_OUTPUT"

  container-image:
    name: Build, Test and Release
    needs: prepare-release-tag
    permissions:
      contents: write
      id-token: write
      actions: read
      pull-requests: write
    uses: ukhsa-collaboration/devops-github-reusable-workflows/.github/workflows/container-image-build-python-aws-ecs.yml@6af49b74eb18b2b1048b39375c3cc403a0af8353
    with:
      app_name: ${{ vars.APP_NAME }}
      service_identifier: ${{ vars.ECR_NAMESPACE }}
      aws_region: ${{ vars.AWS_REGION }}
      run_unit_tests: ${{ vars.RUN_UNIT_TESTS == 'true' }}
      unit_test_command: uv run pytest 
      push_image: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
      release_tag: ${{ needs.prepare-release-tag.outputs.release_tag }}
      sign_release: true
      lint_dockerfile: true
      deploy_environments: >-
        [
          { "name": "dev", "base_url": "https://example.com", "smoke_test_url": "https://example.com" },
        ]
    secrets: inherit